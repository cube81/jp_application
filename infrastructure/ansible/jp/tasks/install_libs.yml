---
- name: Update apt-get repo and cache
  apt: update_cache=yes cache_valid_time=3600
  #apt: update_cache=yes force_apt_get=yes cache_valid_time=3600
  become: true

- name: Upgrade all packages on servers
  apt: upgrade=dist force_apt_get=yes
  become: true
  
- name: Install python pip
  become: true
  become_method: sudo
  apt:
    pkg:
      - python3-apt
      - python3-dev
      - python3-pip
  connection: local
  register: apt_action
  retries: 100
  until: apt_action is success or ('Failed to lock apt for exclusive operation' not in apt_action.msg and '/var/lib/dpkg/lock' not in apt_action.msg)

- name: Install Python Libs
  become: true
  become_method: sudo
  apt:
    pkg:
      - libxml2
      - libxml2-dev
      - libxslt1-dev
      - lib32z1-dev
      - libssl-dev
      - zlib1g-dev
  connection: local
  register: apt_action
  retries: 100
  until: apt_action is success or ('Failed to lock apt for exclusive operation' not in apt_action.msg and '/var/lib/dpkg/lock' not in apt_action.msg)

- name: Install fucking lxml
  become_method: sudo
  become: true
  command: "pip3 install lxml"
  environment:
    CFLAGS: "-O0"
  connection: local
  

- name: Download app from Artifactory
  maven_artifact:
    group_id: pl.jp
    artifact_id: jpapp
    repository_url: "{{ repository_url }}"
    username: "{{ username }}"
    password: "{{ password }}"
    dest: "{{ artifact_name }}"
  connection: local
